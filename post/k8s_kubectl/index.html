<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kubectl - Morgoth</title>
    <meta name="description" content="">
    
    
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background: #fff;
            padding: 1rem 0;
            border-bottom: 1px solid #ddd;
            margin-bottom: 2rem;
        }
        nav {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        nav a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
        }
        nav a:hover {
            color: #007acc;
        }
        .site-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007acc;
        }
        main {
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .post-meta {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        .post-content h1, .post-content h2, .post-content h3 {
            margin-top: 2rem;
            margin-bottom: 1rem;
        }
        .post-list {
            list-style: none;
            padding: 0;
        }
        .post-list li {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
        }
        .post-list h2 {
            margin: 0 0 0.5rem 0;
        }
        .post-list h2 a {
            text-decoration: none;
            color: #333;
        }
        .post-list h2 a:hover {
            color: #007acc;
        }
        footer {
            text-align: center;
            padding: 2rem 0;
            color: #666;
            border-top: 1px solid #ddd;
            margin-top: 2rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <nav>
                <a href="https://canuxcheng.com/" class="site-title">Morgoth</a>
                
                    <a href="/">Home</a>
                
                    <a href="/about/">About</a>
                
                    <a href="/categories/">Categories</a>
                
                    <a href="/tags/">Tags</a>
                
                    <a href="/rtfm/">RTFM</a>
                
                    <a href="/samuel/">Samuel</a>
                
            </nav>
        </div>
    </header>
    
    <div class="container">
        <main>
            
<div class="single-post">
    <article>
        <header>
            <h1>Kubectl</h1>
            <div class="post-meta">
                <time>January 10, 2020</time>
                
                    
                        <span class="category">CNCF</span>
                    
                
                
                    
                        <span class="tag">#tag</span>
                    
                
            </div>
        </header>
        
        <div class="post-content">
            <h1 id="kubectl">kubectl</h1>
<p>kubectl是kubernetes的管理工具.</p>
<p><a href="https://kubernetes.io/docs/tasks/tools/#kubectl">https://kubernetes.io/docs/tasks/tools/#kubectl</a></p>
<p><a href="https://github.com/cloudnativelabs/kube-shell">https://github.com/cloudnativelabs/kube-shell</a></p>
<p><a href="https://github.com/jonmosco/kube-ps1">https://github.com/jonmosco/kube-ps1</a></p>
<p><a href="https://github.com/ahmetb/kubectx">https://github.com/ahmetb/kubectx</a></p>
<p>在master上通过kubectl命令管理集群.</p>
<p>kubectl 版本和集群版本之间的差异必须在一个小版本号内。 例如：v1.24 版本的客户端能与 v1.23、 v1.24 和 v1.25 版本的控制面通信。 用最新兼容版的 kubectl 有助于避免不可预见的问题。</p>
<h2 id="options">Options</h2>
<pre><code>kubectl options # 查看所有命令可用选项

--kubeconfig
kubectl --kubeconfig=$HOME/.kube.config (default)

-n/--namespace
</code></pre>
<h2 id="basic-command">basic command</h2>
<p>create:</p>
<pre><code># 通过yaml或json文件创建资源
$ kubectl create -f FILENAME [options]

options:
-f/--filename

kubectl create secret tls kubernetes-dashboard-tls --key ca.key --cert ca.crt -n kubernetes-dashboard

// 输出一个资源的yaml格式.
kubectl create deployment &lt;name&gt; --image=&lt;img-name&gt; --dry-run=client --output=yaml
</code></pre>
<p>delete:</p>
<pre><code>// 删除资源
$ kubectl delete (-f FILENAME | -k DICT | TYPE [(NAME|-l label|--all)]) [optiions]

options:
-f/--filename
--all  
--all-namespaces
--force

$ kubectl delete pods --all
$ kubectl delete pod &lt;name&gt;
// 删除指定ns下所有资源.
$ kubectl delete all --all -n {namespace}
</code></pre>
<p>删除带有finalizers字段的对象，对象实际被更新了，没有真的被删除。可以通过patch来删除。</p>
<p>删除带有ownerReferences字段的对象，删除父对象默认会删除所有子对象，通过&ndash;cascade=false只删除父对象。</p>
<p>expose:</p>
<pre><code># 创建serivce:
$ kubectl expose (-f FILENAME | TYPE NAME) [--port=port] [--protocol=TCP|UDP|SCTP] [--target-port=...] [--name=...] [--external-ip=...] [--type=type] [options]

# 创建service，并且使用NodePort
# nodeport可以使用任意节点的IP访问.
$ kubectl expose deployment hello-world --type=NodePort --name=example-service

// 获取service的yaml
kubectl expose deployment &lt;deploy-name&gt; --type=LoadBalancer --port=80 --dry-run=client --output=yaml
</code></pre>
<p>run:</p>
<pre><code># 创建pod/container(docker run):
$ kubectl run NAME --image=image [--env=&quot;key=value&quot;] [--port=port] [--replicas=replicas] [--dry-run=bool] [--overrides=inline-json] [--command] -- [COMMAND] [args...] [options]
</code></pre>
<p>set:</p>
<pre><code>$ kubectl set SUBCOMMAND [options]

// 更新镜像
$ kubectl set image deployment.v1.apps/&lt;deploy-name&gt; &lt;container-name&gt;=&lt;image:tag&gt;
</code></pre>
<p>get:</p>
<pre><code>// 获取resource信息(docker ps)
$ kubectl [-n &lt;namespace&gt;] get [resource] [flags] [options]

options:
-A/--all-namespaces
-f/--filename
-o/--output json/yaml/json/wide/name/...
-w/--watch
--watch-only

kubectl get nodes --show-labels

kubectl get nodes/no # 获取node节点信息
kubectl get namespace/ns # 获取namespace信息
kubectl get componentstatuses/cs

kubectl get all --all-namespaces
kubectl -n kube-system get all 

kubectl get pod/pods/po 
kubectl get po -w/--watch
kubectl get po -o wide

kubectl get deployment/deployments/deploy

kubectl get service/services/svc
</code></pre>
<p>explain:</p>
<p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.17/">https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.17/</a></p>
<pre><code>// 查看资源解析
$ kubectl explain RESOURCE [options]

kubectl explain deploy.spec
</code></pre>
<p>edit:</p>
<pre><code>// 在线修改资源，直接生效.
$ kubectl edit
</code></pre>
<h2 id="advanced-commands">advanced commands</h2>
<p>apply:</p>
<pre><code>$ kubectl apply
</code></pre>
<p>diff:</p>
<pre><code>$ kubectl diff
</code></pre>
<p>patch</p>
<pre><code>$ kubectl patch

// 删除terminating状态的resource
$ kubectl patch  persistentvolumeclaim/storage -p '{&quot;metadata&quot;:{&quot;finalizers&quot;:null}}' -n &lt;ns&gt;

$ kubectl replace

$ kubectl wait

$ kubectl kustomize
</code></pre>
<h2 id="deploy-command">deploy command</h2>
<p>scale:</p>
<pre><code>$ kubectl scale
$ kubectl scale deployment &lt;deploy-name&gt; -n &lt;ns&gt; --replicas=0
</code></pre>
<p>autoscale:</p>
<pre><code>$ kubectl autoscale
</code></pre>
<p>rollout:</p>
<pre><code>// 回滚
$ kubectl rollout

// 暂停/恢复/重启 deployment.
kubectl rollout pause/resume/restart  deploy/katib-mysql -n kubeflow
</code></pre>
<h2 id="debugtroubleshoot">debug&amp;troubleshoot</h2>
<p>describe:</p>
<pre><code>// like docker inspect
$ kubectl describe (-f FILENAME | TYPE ... | TYPE/NAME) [options]

options:
-A/--all-namespaces
-f/--filename

// 查看node信息
$ kubectl describe nodes &lt;name&gt;

//查看pod详细信息
$ kubectl describe pods &lt;name&gt; 

// 获取k8s-dashboard的token
$ kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep admin-user | awk '{print $1}')
</code></pre>
<p>logs:</p>
<pre><code># like docker logs
$ kubectl logs [-f] [-p] (POD | TYPE/NAME) [-c CONTAINER] [options]

options:
--all-containers
-f/--follow
-p/--previous

// 查看pod中指定container log
kubectl logs -f &lt;pod&gt; -c &lt;container&gt; -n &lt;ns&gt;
</code></pre>
<p>exec:</p>
<pre><code># like docker exec
$ kubectl exec (POD | TYPE/NAME) [-c CONTAINER] [flags] -- COMMAND [args...] [options]

options:
-c/--container
-i/--stdin
-t/--tty

$ kubectl exec -it &lt;pod&gt; -n &lt;ns&gt; -- /bin/bash
</code></pre>
<p>port-forward:</p>
<p>由于已知的限制，目前的端口转发仅适用于 TCP 协议.</p>
<p>只能通过运行转发命令的IP/FQDN访问。</p>
<pre><code>$ kubectl port-forward

// 转发本地端口到deploy/rs/svc/pod
$ kubectl port-forward svc/redis-service 6379:6379 -n redis

$ kubectl port-forward --address 0.0.0.0 -n kubernetes-dashboard service/kubernetes-dashboard 8080:443
</code></pre>
<p>proxy:</p>
<pre><code>$ kubectl proxy

// 通过proxy可以访问默认的clusterIP服务.
</code></pre>
<p>attach:</p>
<pre><code>$ kubectl attach
</code></pre>
<p>cp:</p>
<pre><code>$ kubectl cp
</code></pre>
<p>auth:</p>
<pre><code>$ kubectl auth
</code></pre>
<p>debug:</p>
<pre><code>$ kubectl debug

// debug node -- 直接进入node的shell，log在/host/var/log
kubectl debug node/&lt;name&gt;  -it   --image=ubuntu
</code></pre>
<h2 id="cluster-management">cluster management</h2>
<p>top:</p>
<pre><code>$ kubectl top

$ kubectl cluster-info

$ kubectl certificate

// 节点变成unschedulable
$ kubectl cordon

// 节点变成schedulable
$ kubectl uncordon

// 安全下线节点：Ready,SchedulingDisabled
$ kubectl drain
kubectl drain &lt;node&gt; --delete-emptydir-data --ignore-daemonsets

//定义污点
$ kubectl taint
kubectl taint nodes &lt;node&gt; &lt;key&gt;=&lt;value&gt;:NoSchedule-
</code></pre>
<h2 id="settings-commands">Settings Commands</h2>
<p>label</p>
<pre><code>label          Update the labels on a resource

kubectl label nodes &lt;your-node-name&gt; disktype=ssd
</code></pre>
<p>annotate:</p>
<pre><code>annotate       Update the annotations on a resource
</code></pre>
<p>completion:</p>
<pre><code>completion     Output shell completion code for the specified shell (bash or zsh)
</code></pre>
<h2 id="others">others</h2>
<p>api-resources:</p>
<pre><code>// api-resources  Print the supported API resources on the server.
kubectl api-resources
</code></pre>
<p>api-versions:</p>
<pre><code>// api-versions   Print the supported API versions on the server, in the form of &quot;group/version&quot;.
kubectl api-versions
</code></pre>
<p>config:</p>
<pre><code>// 参考kubectx
config         Modify kubeconfig files.
</code></pre>
<p>plugin:</p>
<pre><code>// 参考krew
plugin         Provides utilities for interacting with plugins.

// 查看安装的plugin
$ kubectl plugin list
</code></pre>
<p>version:</p>
<pre><code>version        Print the client and server version information.
</code></pre>
<hr>
<h2 id="shell-auotcompletion">shell-auotcompletion</h2>
<p>bash/zsh 自动补全工具.</p>
<p><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/#enabling-shell-autocompletion">https://kubernetes.io/docs/tasks/tools/install-kubectl/#enabling-shell-autocompletion</a></p>
<pre><code>$ kubectl completion bash | sudo tee /etc/bash_completion.d/kubectl
</code></pre>
<h1 id="krew">krew</h1>
<p><a href="https://github.com/kubernetes-sigs/krew">https://github.com/kubernetes-sigs/krew</a></p>
<p>安装kubectl plugin的工具</p>
<pre><code>// 下载插件列表
$ kubectl krew update

// 查找插件
$ kubectl krew search

// 安装插件
$ kubectl krew install &lt;name&gt;

// 升级插件
$ kubectl krew upgrade

// 卸载插件
$ kubectl krew uninstall &lt;name&gt;
</code></pre>
<h2 id="kubectx">kubectx</h2>
<p><a href="https://github.com/ahmetb/kubectx">https://github.com/ahmetb/kubectx</a></p>
<p>在cluster和namespace之间切换的命令行工具.</p>
<p>包括kubectx 和 kubedns</p>
<p>通过krew安装，作为kubectl的plugin:</p>
<pre><code>$ kubectl krew install ctx
$ kubectl krew install ns
</code></pre>
<h1 id="circtl">circtl</h1>
<p>用于对node调试.</p>
<p><a href="https://github.com/kubernetes-sigs/cri-tools">https://github.com/kubernetes-sigs/cri-tools</a></p>
<p><a href="https://kubernetes.io/docs/tasks/debug/debug-cluster/crictl/">https://kubernetes.io/docs/tasks/debug/debug-cluster/crictl/</a></p>
<h2 id="nerdctl">nerdctl</h2>
<p>调试node。</p>
<p><a href="https://github.com/containerd/nerdctl">https://github.com/containerd/nerdctl</a></p>
<h2 id="telepresence">telepresence</h2>
<p>用于本地调试集群上的服务.</p>
<p><a href="https://github.com/telepresenceio/telepresence">https://github.com/telepresenceio/telepresence</a></p>

        </div>
    </article>
</div>

        </main>
    </div>
    
    <footer>
        <div class="container">
            <p>&copy; 2025 Morgoth. Designed by Canux</p>
        </div>
    </footer>
</body>
</html>
