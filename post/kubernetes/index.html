<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kubernetes - Morgoth</title>
    <meta name="description" content="">
    
    
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background: #fff;
            padding: 1rem 0;
            border-bottom: 1px solid #ddd;
            margin-bottom: 2rem;
        }
        nav {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        nav a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
        }
        nav a:hover {
            color: #007acc;
        }
        .site-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007acc;
        }
        main {
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .post-meta {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        .post-content h1, .post-content h2, .post-content h3 {
            margin-top: 2rem;
            margin-bottom: 1rem;
        }
        .post-list {
            list-style: none;
            padding: 0;
        }
        .post-list li {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
        }
        .post-list h2 {
            margin: 0 0 0.5rem 0;
        }
        .post-list h2 a {
            text-decoration: none;
            color: #333;
        }
        .post-list h2 a:hover {
            color: #007acc;
        }
        footer {
            text-align: center;
            padding: 2rem 0;
            color: #666;
            border-top: 1px solid #ddd;
            margin-top: 2rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <nav>
                <a href="https://canuxcheng.com/" class="site-title">Morgoth</a>
                
                    <a href="/">Home</a>
                
                    <a href="/about/">About</a>
                
                    <a href="/categories/">Categories</a>
                
                    <a href="/tags/">Tags</a>
                
                    <a href="/rtfm/">RTFM</a>
                
                    <a href="/samuel/">Samuel</a>
                
            </nav>
        </div>
    </header>
    
    <div class="container">
        <main>
            
<div class="single-post">
    <article>
        <header>
            <h1>Kubernetes</h1>
            <div class="post-meta">
                <time>April 5, 2018</time>
                
                    
                        <span class="category">CNCF</span>
                    
                
                
                    
                        <span class="tag">#k8s</span>
                    
                
            </div>
        </header>
        
        <div class="post-content">
            <h1 id="kubernetes">Kubernetes</h1>
<p><a href="https://github.com/kubernetes/kubernetes">https://github.com/kubernetes/kubernetes</a></p>
<p><a href="https://github.com/kubernetes/kubeadm">https://github.com/kubernetes/kubeadm</a></p>
<p><a href="https://github.com/kubernetes/kops">https://github.com/kubernetes/kops</a></p>
<p><a href="https://github.com/kubernetes-sigs/kubespray">https://github.com/kubernetes-sigs/kubespray</a></p>
<p>kubernetes简称k8s, 是开源的容器编排工具。</p>
<p>安装单机版k8s:</p>
<ul>
<li>minikube</li>
</ul>
<p>安装k8s集群:</p>
<ul>
<li>kubeadm (k8s内置的，类似于docker swarm mode, 没有HA)</li>
<li>kops (目前主要支持aws等云平台, 国内不友好)</li>
<li>kubespray (通过ansible部署, 国内不友好)</li>
</ul>
<p>k8s发行版：</p>
<ul>
<li>openshift-okd(redhat)</li>
<li>rancher</li>
</ul>
<h1 id="k8s集群组成">k8s集群组成</h1>
<h2 id="master">master</h2>
<ul>
<li>aip-server, 提供资源操作唯一入口</li>
<li>scheduler, 负责资源调度</li>
<li>controller-manager, 负责维护集群状态</li>
<li>etcd(可以部署单独集群), 保存整个集群的状态</li>
</ul>
<h2 id="node">node</h2>
<ul>
<li>kubelet, 负责维护容器生命周期, 还包括CNI CVI</li>
<li>kube-proxy, 为service提供cluster内部的服务发现和负载均衡</li>
<li>CRI(containerd), 创建pod</li>
</ul>
<h2 id="addons">addons</h2>
<ul>
<li>coredns</li>
<li>flannel/cilium/calico</li>
<li>dashboard, web-gui</li>
<li>metrics-server, 取代heapster，用于cpu/memory监控</li>
<li>ingress-nginx, 为服务提供外网入口</li>
<li>federation, 提供跨可用区的集群</li>
</ul>
<hr>
<h1 id="概念">概念</h1>
<p>k8s包含的重要概念:</p>
<p>-: nodes, 运行pod的物理机或虚拟机.
-: namespace, 对资源和对象的抽象集合．pods/deployments/services都属于某个ns.
-: pods,一组紧密关联的容器集合，共享pid,ipc,network,uts,namespace.</p>
<p>k8s业务类型:</p>
<p>-: long-running 长期伺服型 -&gt; RC, RS, Deployment
-: batch 批处理型-&gt; Job
-: node-daemon 节点后台支撑型-&gt; DaemonSet
-: stateful application 有状态应用型-&gt; StatefulSet</p>
<p>api对象三大类属性:</p>
<ul>
<li>metadata 元数据(至少包含namespace, name, uid).</li>
<li>spec 规范</li>
<li>status 状态</li>
</ul>
<p>kubernetes对外暴露服务的三种方式:</p>
<ul>
<li>NodePort: dev/qa. (30000-32767)</li>
<li>Ingress: production.</li>
<li>LoadBalance: cloud provider.</li>
</ul>
<p>clusterIP 是k8s内部默认服务，外部无法访问，可以通过proxy来访问。</p>
<hr>
<h1 id="pod">pod</h1>
<p>一个pod包含一个或多个容器，这些容器通过infra container共享同一个network namespace。</p>
<p>infra container: k8s.gcr.io/pause, 汇编写的，永远处于暂停状态。</p>
<p>pod共享网络:</p>
<p>同一个pod里面看到的网络跟infra容器看到的是一样的，一个pod只有一个ip,也就是这个Pod的network namespace对应的IP; 整个pod的生命周期跟infra容易是一样的。</p>
<p>pod共享存储:</p>
<p>通过pod volumes, 使pod中的container共享存储。</p>
<p>应用:</p>
<ul>
<li>一个pod中的某个容器异常退出，被kubelet拉起来之前保证之前的数据部丢失.</li>
<li>同一个pod的多个容器共享数据.</li>
</ul>
<p>pod volume类型:</p>
<ol>
<li>
<p>本地存储: emptydir/hostpath&hellip;</p>
</li>
<li>
<p>网络存储:</p>
<p>in-tree(ks8内置支持): awsElasticBlockStore/gcePresistentDisk/nfs&hellip;</p>
<p>out-of-tree(插件): flexvolume/csi&hellip;</p>
</li>
<li>
<p>projected volume: secret/configmap/downwardAPI/serviceAccountToken</p>
</li>
</ol>
<p>pod服务质量配置:</p>
<p>依据容器对cpu,memory资源的request/limit需求，pod服务质量分类:</p>
<ul>
<li>Guaranteed</li>
<li>Burstable</li>
<li>BestEffort</li>
</ul>
<p>initContainer:</p>
<p>initContainer用于普通Container启动前的初始化（如配置文件准备) 和 前置条件校验 (如网络)。</p>
<ol>
<li>initContainer会先于普通container启动执行，直到所有initcontainer执行成功后，普通container 才会执行。</li>
<li>pod中多个initcontainer之间是按次序依次启动执行，而pod中多个普通container是并行启动。</li>
<li>initcontainer 执行成功后就结束退出，而普通container会一直执行或重启。</li>
</ol>
<hr>
<h1 id="resources">resources</h1>
<p>查看所有对象:</p>
<pre><code>$ kubectl api-resources
</code></pre>
<p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.17/#statefulsetcondition-v1beta2-apps">https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.17/#statefulsetcondition-v1beta2-apps</a></p>
<h2 id="workloads">Workloads</h2>
<h3 id="replicasetsrs">replicasets/rs</h3>
<p>控制无状态的pod数量,增删Pods.</p>
<h3 id="deploymentsdeploy">deployments/deploy</h3>
<p>定义pod的数目和版本，通过Controller自动恢复失败的pod，滚动升级，重新生成，回滚等。</p>
<p>DeploymentStatus: complete, processing, failed</p>
<p>Deployment只负责管理不同版本的ReplicaSet, 由ReplicaSet管理Pod副本个数; 每个版本的ReplicaSet对应了Deployment template的一个版本; 一个ReplicaSet下的Pod都是相同的版本.</p>
<h3 id="daemonsetsds">daemonsets/ds</h3>
<p>ds作用:</p>
<ul>
<li>保证集群内每个节点运行一组相同的pod</li>
<li>跟踪集群节点状态，保证新加入的节点自动创建对应的pod</li>
<li>跟踪集群节点状态，保证移除的节点删除对应的pod</li>
<li>跟踪pod状态，保证每个节点pod处于运行状态</li>
</ul>
<h3 id="jobs">jobs</h3>
<p>job的作用:</p>
<ul>
<li>创建一个或多个pod确保指定数量的Pod可以成功运行和终止.</li>
<li>跟踪pod状态，根据配置及时重试失败的pod.</li>
<li>确定依赖关系，保证上一个任务运行完毕后再运行下一个任务.</li>
<li>控制任务并行度，并根据配置确保pod队列大小。</li>
</ul>
<h3 id="cronjobscj">cronJobs/cj</h3>
<h3 id="statefulsetssts">statefulsets/sts</h3>
<p>控制有状态的pod数量.</p>
<hr>
<h2 id="service-discovery--load-balancing">service discovery &amp; load balancing</h2>
<h3 id="servicessvc">services/svc</h3>
<p>提供访问一个或多个pod的稳定的访问地址.支持ClusterIP, NodePort, LoadBalancer等访问方式.</p>
<h3 id="ingresses">ingresses</h3>
<h3 id="endpointslices">endpointslices</h3>
<hr>
<h2 id="config--storage">Config &amp; Storage</h2>
<h3 id="secrets">secrets</h3>
<p>secret用于在集群中存储密码，token等敏感信息用的资源对象.</p>
<p>其中敏感数据采用base-64编码保存.</p>
<p>四种类型:</p>
<ul>
<li>Opaque</li>
<li>kubernetes.io/service-account-token</li>
<li>kubernetes.io/dockerconfigjson</li>
<li>bootstrap.kubernetes.io/token</li>
</ul>
<p>secret主要被pod使用，一般通过volume挂载到指定容器目录，供容器中业务使用.</p>
<p>访问私有镜像仓库也可以通过secret实现.</p>
<p>secret大小限制1M; secret不适合机密信息，推荐用vault.</p>
<h3 id="configmapscm">configmaps/cm</h3>
<p>主要管理容器运行所需的配置文件，环境变量，命令行参数等可变配置。</p>
<p>可用于解耦容器镜像和可变配置，从而保障工作负载的可移植性.</p>
<p>主要被pod使用，一般用于挂载pod用的配置文件，环境变量，命令行参数.</p>
<p>ConigMap 大小不超过1M; pod只能引用相同namespace中的configmap, pod引用的configmap不存在时，pod无法创建;使用envFrom从ConfigMap配置环境变量时，如果ConfigMap中的某些key被认为无效，该环境变量不会注入容器，但是pod可以创建; 只有通过k8s api创建的pod才能使用ConfigMap, 其它方式创建的pod不能使用ConfigMap.</p>
<h3 id="persistentvolumepv">persistentvolume/pv</h3>
<p>static volume provisioning:</p>
<p>dynamic volume provisioning:</p>
<h3 id="persistentvolumeclaimspvc">persistentvolumeclaims/pvc</h3>
<p>pvc中只需要申明需要的存储size, access mode等业务需求.</p>
<p>pvc简化了用户对存储的需求，pv才是存储的实际信息载体，通过kube-controller-manager中的PersistentVolumeController将PVC与合适的PV 绑定.</p>
<h3 id="csidrivers">csidrivers</h3>
<h3 id="csinodes">csinodes</h3>
<h3 id="storageclassessc">storageclasses/sc</h3>
<h3 id="volumeattachments">volumeattachments</h3>
<hr>
<h2 id="metadata">metadata</h2>
<h3 id="events">events</h3>
<h3 id="horizontalpodautoscaler">horizontalpodautoscaler</h3>
<h3 id="podtemplate">podtemplate</h3>
<hr>
<h2 id="cluster">cluster</h2>
<h3 id="componentstatusescs">componentstatuses/cs</h3>
<h3 id="namespacesns">namespaces/ns</h3>
<p>一个集群内部的逻辑隔离机制，每个资源都属于一个namespace，同一个namespace中的资源命名唯一，不同namespace中的资源可重名.</p>
<h3 id="nodesno">nodes/no</h3>
<h3 id="serviceaccountsa">serviceaccount/sa</h3>
<p>解决pod在集群中的身份认证问题.</p>
<hr>
<h1 id="tools">Tools</h1>
<p>sonobuoy</p>
<p><a href="https://github.com/vmware-tanzu/sonobuoy">https://github.com/vmware-tanzu/sonobuoy</a></p>
<p>kuard</p>
<p><a href="https://github.com/kubernetes-up-and-running/kuard">https://github.com/kubernetes-up-and-running/kuard</a></p>

        </div>
    </article>
</div>

        </main>
    </div>
    
    <footer>
        <div class="container">
            <p>&copy; 2025 Morgoth. Designed by Canux</p>
        </div>
    </footer>
</body>
</html>
