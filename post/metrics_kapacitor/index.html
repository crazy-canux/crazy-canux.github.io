<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kapacitor - Morgoth</title>
    <meta name="description" content="">
    
    
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background: #fff;
            padding: 1rem 0;
            border-bottom: 1px solid #ddd;
            margin-bottom: 2rem;
        }
        nav {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        nav a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
        }
        nav a:hover {
            color: #007acc;
        }
        .site-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007acc;
        }
        main {
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .post-meta {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        .post-content h1, .post-content h2, .post-content h3 {
            margin-top: 2rem;
            margin-bottom: 1rem;
        }
        .post-list {
            list-style: none;
            padding: 0;
        }
        .post-list li {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
        }
        .post-list h2 {
            margin: 0 0 0.5rem 0;
        }
        .post-list h2 a {
            text-decoration: none;
            color: #333;
        }
        .post-list h2 a:hover {
            color: #007acc;
        }
        footer {
            text-align: center;
            padding: 2rem 0;
            color: #666;
            border-top: 1px solid #ddd;
            margin-top: 2rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <nav>
                <a href="https://canuxcheng.com/" class="site-title">Morgoth</a>
                
                    <a href="/">Home</a>
                
                    <a href="/about/">About</a>
                
                    <a href="/categories/">Categories</a>
                
                    <a href="/tags/">Tags</a>
                
                    <a href="/rtfm/">RTFM</a>
                
                    <a href="/samuel/">Samuel</a>
                
            </nav>
        </div>
    </header>
    
    <div class="container">
        <main>
            
<div class="single-post">
    <article>
        <header>
            <h1>Kapacitor</h1>
            <div class="post-meta">
                <time>January 18, 2018</time>
                
                    
                        <span class="category">DevOps</span>
                    
                
                
                    
                        <span class="tag">#monitoring</span>
                    
                
            </div>
        </header>
        
        <div class="post-content">
            <h1 id="kapacitor">Kapacitor</h1>
<p><a href="https://github.com/influxdata/Kapacitor">https://github.com/influxdata/Kapacitor</a></p>
<p>Open source framework for processing, monitoring, and alerting on time series data</p>
<p>可以通过chrongraf创建tickscript/task, 然后通过api/cli导入到kapacitor.</p>
<p>配置:</p>
<pre><code>hostname = &quot;kapcitor-service&quot;

# 如果从influxdb读取数据需要配置该选项．
[[influxdb]]
enabled = true

# 如果从该路径加载tickscript
[[load]]
enabled = true
dir=&quot;/etc/kapacitor/load&quot;
# tasks, 放到/etc/kapacitor/load/tasks/*.tick,重启kapacitor会自动加载task,并默认enable.
## 要求，ID和tick文件同名，tickscript开头需要指定dbrp, tickscript里面需要指定batch/stream.
# templates...
# handlers...
</code></pre>
<hr>
<h1 id="cli">CLI</h1>
<pre><code>$ kapacitor help

# 创建template(也就是变量可以单独赋值的tickscript)
$ kapacitor define-template &lt;name&gt; -tick /path/template.tick
$ kapacitor show-template &lt;name&gt;

# 创建/更新 task, 创建的默认是disable状态.
# 从tickscript创建task
$ kapacitor define &lt;name&gt; -tick task.tick -type [stream|batch] -dbrp [database.retentionPolicy]
# 从template创建task(如果yaml/json中没有指定template需要用-template指定)
$ kapacitor define &lt;name&gt; -file task.yaml
$ kapacitor define &lt;name&gt; -file task.json

# 删除task
$ kapacitor delete [task id/name]

$ kapacitor list tasks/templates
$ kapacitor reload [task id/name] # 相当于disable &amp; enable.
$ kapacitor enable [task id/name]
$ kapaciror disable [task id/name]
$ kapacitor show [id/name]
$ kapacitor watch [task id/name]

$ kapacitor list topics
$ kapacitor delete topics [topic id]
</code></pre>
<hr>
<h1 id="http-api">Http API</h1>
<pre><code>port = 9092
</code></pre>
<h2 id="configuration">configuration</h2>
<p>获取所有可以overwrite的参数</p>
<pre><code>GET /kapacitor/v1/config
</code></pre>
<p>获取section/option参数</p>
<pre><code>GET /kapacitor/v1/config/smtp
GET /kapacitor/v1/config/smtp/
GET /kapacitor/v1/config/influxdb
GET /kapacitor/v1/config/influxdb/localhost

POST /kapacitor/v1/config/smtp/
{
    &quot;set&quot;:{
        &quot;enabled&quot;: true
    }
}
</code></pre>
<p>操作task:</p>
<pre><code>// 修改已存在的task的参数:
$ curl -H 'content-type: application/json' -X PATCH -d '{&quot;vars&quot;: {&quot;warn&quot;:{&quot;value&quot;:90, &quot;type&quot;:&quot;int&quot;}}}' http://kapacitor-service:9092/kapacitor/v1/tasks/cpu
</code></pre>
<p>操作alert:</p>
<pre><code>// 列出所有topic:
$ curl -H 'content-type: application/json' -X GET http://kapacitor-service:9092/kapacitor/v1/alerts/topics
// 列出指定topic的所有events:
$ curl -H 'content-type: application/json' -X GET http://kapacitor-service:9092/kapacitor/v1/alerts/topics/&lt;topic&gt;/events
// 列出指定events
$ curl -H 'content-type: application/json' -X GET http://kapacitor-service:9092/kapacitor/v1/alerts/topics/&lt;topic&gt;/events/&lt;event&gt;?min-level=CRITICAL
</code></pre>
<hr>
<h1 id="tickscript">TICKscript</h1>
<p>注释:</p>
<pre><code>// comment
</code></pre>
<p>tickscript字符串用单引号和三单引号表示.</p>
<pre><code>var a = 'test'
var b = '''test1
test2'''
</code></pre>
<p>Keywords:</p>
<pre><code>TRUE
FALSE
AND
OR
lambda
var
dbrp
</code></pre>
<p>operator:</p>
<pre><code>+ - * /    算数运算
== != &lt; &lt;= &gt; &gt;=    比较运算
=~ !~    正则表达式匹配和不匹配
! AND OR    逻辑运算
</code></pre>
<p>chaining operators:</p>
<pre><code>|    chaining method (constructor)
.    property method (property methods &amp; event handlers)
@    User Define Function
</code></pre>
<p>status:</p>
<pre><code>0 -&gt; OK
1 -&gt; INFO
2 -&gt; WARN
3 -&gt; CRIT
</code></pre>
<hr>
<h1 id="node">node</h1>
<p>node是tickscript中的复杂数据结构．</p>
<p>两个顶级node类型是stream和batch</p>
<p>batch是定时查询influxdb.</p>
<p>stream是通过订阅influxdb,写入到influxdb的数据也会写入kapacitor.</p>
<p>constructor调用相应的property methods.</p>
<h2 id="stream">stream</h2>
<pre><code>var data = stream
    |from()...
</code></pre>
<p>property methods:</p>
<pre><code>quiet()
</code></pre>
<p>chaining methods:</p>
<pre><code>Deadman
From
Stats
</code></pre>
<h2 id="batch">batch</h2>
<pre><code>var data = batch
    |query()...
</code></pre>
<p>property methods:</p>
<pre><code>quiet()
</code></pre>
<p>chaining methods:</p>
<pre><code>Deadman
Query
Stats
</code></pre>
<h2 id="alert">alert</h2>
<p>alert有三种类型: threshold, relative, deadman.</p>
<pre><code>var alert = data
    |eval()...
    |alert()
      .id('{{ index .Tags &quot;&lt;tag-key&gt;&quot; }}')
      .message('{{ .ID }} {{ .Level }} {{ index .Fields &quot;&lt;field-key&gt;&quot; }} {{ .Time }}')
      .details(...)
      ...
</code></pre>
<p>constructor:</p>
<pre><code>alert()
</code></pre>
<p>property methods:</p>
<pre><code>id()    # 定义alert的ID
message()    # 相当于email的subject.
details()    # html格式的警告信息，相当于email的body.
info()
infoReset()
warn()
warnReset()
crit()
critReset()
email()
log()    # 将json格式的alert存放到文件．
idTag
idField
levelTag()
levelField()
durationField()
messageField()
post()
tcp()
all()    # period里面所有值都满足条件才alert
topic()
flapping()
history()
inhibit(&lt;category&gt;, &lt;tags&gt;) // 忽略一类告警
quiet()
noRecoveries() # 不要发恢复(OK)的警告
stateChangesOnly() # 状态改变才发警告,OK/INFO/WARNING/CRITICAL
category()
</code></pre>
<p>message/details event data:</p>
<pre><code># 通过property methods定义一些变量
ID -&gt; {{ .ID }}
Name -&gt; measurement
TaskName -&gt; task name
Group -&gt; groupBy
Tags -&gt; {{.Tags}} {{index .Tags &quot;&lt;tag_key&gt;&quot;}}
Fields -&gt; {{.Fields}} {{index .Fields &quot;&lt;field_key&gt;&quot;}}
Message
Details
Time -&gt; {{ .Time }}
Duration -&gt; {{ .Duration }}
Level -&gt; {{ .Level }}
Data
Recoverable
</code></pre>
<h2 id="query">query</h2>
<p>constructor:</p>
<pre><code>query(q string)
</code></pre>
<p>property methods:</p>
<pre><code>fill()
align()
alignGroup()
groupBy()
cron()
every()
period()
quiet()
</code></pre>
<h2 id="from">from</h2>
<p>constructor:</p>
<pre><code>from()
</code></pre>
<p>property methods:</p>
<pre><code>database()
retentionPolicy()
measurement()
where()
groupBy()
round()
truncate()
quiet()
</code></pre>
<h2 id="window">window</h2>
<p>constructor:</p>
<pre><code>window()
</code></pre>
<p>property methods:</p>
<pre><code>every()
period()
align()
quiet()
</code></pre>
<h2 id="log">Log</h2>
<p>constructor:</p>
<pre><code>log()
</code></pre>
<p>property methods:</p>
<pre><code>level()
prefix()
quiet()
</code></pre>
<h2 id="influxdbout">influxDBOut</h2>
<p>constructor:</p>
<pre><code>influxDBOut()
</code></pre>
<p>property methods:</p>
<pre><code>create()
...
</code></pre>
<hr>
<h1 id="handler">handler</h1>
<p>handler是用来处理alert的工具, 最常用的是email</p>
<p>handler可以调用相应的options.</p>
<h2 id="email">email</h2>
<p>options:</p>
<pre><code>to(&quot;&lt;email_address&gt;&quot;)
</code></pre>
<p>需要配置smtp</p>
<pre><code>[smtp]
    enabled = true
    host = &quot;localhost&quot;  # 一般postfix/mailutils和kapacitor安装到同一台server
    port = 25

    from = &quot;canuxcheng@gmail.com&quot;  # 必须配置
    to = [&quot;&quot;]  # 可以在tickscript中指定, tickscript不指定，就用该配置.

    global = true # 开启后,tickscript中不用指定handler,默认都是发邮件.
</code></pre>
<h2 id="log-1">log</h2>
<p>options:</p>
<pre><code>path
mode
</code></pre>
<p>写入到log.</p>
<h2 id="slack">slack</h2>
<h2 id="post">post</h2>
<h2 id="tcp">tcp</h2>

        </div>
    </article>
</div>

        </main>
    </div>
    
    <footer>
        <div class="container">
            <p>&copy; 2025 Morgoth. Designed by Canux</p>
        </div>
    </footer>
</body>
</html>
