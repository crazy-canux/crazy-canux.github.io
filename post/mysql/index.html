<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mysql - Morgoth</title>
    <meta name="description" content="">
    
    
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background: #fff;
            padding: 1rem 0;
            border-bottom: 1px solid #ddd;
            margin-bottom: 2rem;
        }
        nav {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        nav a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
        }
        nav a:hover {
            color: #007acc;
        }
        .site-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007acc;
        }
        main {
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .post-meta {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        .post-content h1, .post-content h2, .post-content h3 {
            margin-top: 2rem;
            margin-bottom: 1rem;
        }
        .post-list {
            list-style: none;
            padding: 0;
        }
        .post-list li {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
        }
        .post-list h2 {
            margin: 0 0 0.5rem 0;
        }
        .post-list h2 a {
            text-decoration: none;
            color: #333;
        }
        .post-list h2 a:hover {
            color: #007acc;
        }
        footer {
            text-align: center;
            padding: 2rem 0;
            color: #666;
            border-top: 1px solid #ddd;
            margin-top: 2rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <nav>
                <a href="https://canuxcheng.com/" class="site-title">Morgoth</a>
                
                    <a href="/">Home</a>
                
                    <a href="/about/">About</a>
                
                    <a href="/categories/">Categories</a>
                
                    <a href="/tags/">Tags</a>
                
                    <a href="/rtfm/">RTFM</a>
                
                    <a href="/samuel/">Samuel</a>
                
            </nav>
        </div>
    </header>
    
    <div class="container">
        <main>
            
<div class="single-post">
    <article>
        <header>
            <h1>Mysql</h1>
            <div class="post-meta">
                <time>May 25, 2016</time>
                
                    
                        <span class="category">Database</span>
                    
                
                
                    
                        <span class="tag">#mysql</span>
                    
                
            </div>
        </header>
        
        <div class="post-content">
            <h1 id="mysql">Mysql</h1>
<p>安装mysql服务器</p>
<pre><code>$ sudo apt-get install mysql-server
$ sudo yum install mysql-community-server

$ sudo vim /etc/mysql/mysql.conf.d/mysqld.cnf
# 注意mysql的/etc/mysql/my.cnf和相关文件如果设置了bind-address = 127.0.0.1就无法远程访问，需要注释掉．
</code></pre>
<p>安装mysql客户端</p>
<pre><code>$ sudo apt-get install mysql-client
$ sudo yum install mysql-community-client
</code></pre>
<p>安装开发工具：</p>
<pre><code>$ sudo apt-get install libmysqlclient-dev
</code></pre>
<p>CLI工具： mysql</p>
<p>GUI工具： mysql workbench</p>
<p>安装完成默认的数据库是 mysql。</p>
<p>mysqld的默认端口是3306.</p>
<hr>
<h1 id="mysql命令">mysql命令</h1>
<p>tips: 用户名密码有特殊字符用引号.</p>
<pre><code>$ mysql [OPTIONS] [database]
</code></pre>
<p>初始化时需要用root用户进入mysql命令行</p>
<pre><code>$ mysql -uroot -p
$ mysql -h&lt;host&gt; -P&lt;port&gt; -uroot -p&lt;password&gt;
</code></pre>
<p>创建用户后用其它用户操作：</p>
<pre><code>$ mysql -u&lt;user&gt; -p
</code></pre>
<p>本地执行sql语句或mysql客户端命令:</p>
<pre><code>$ mysql -u&lt;username&gt; -p&lt;password&gt; &lt;database&gt; -e/--execute &lt;sql query&gt;
$ mysql -u&lt;username&gt; -p&lt;password&gt; &lt;database&gt; &lt; test.sql
</code></pre>
<p>远程执行sql语句或mysql客户端命令:</p>
<pre><code>$ mysql -h&lt;host&gt; -P&lt;port&gt; -u&lt;username&gt; -p&lt;password&gt; &lt;database&gt; -e/--execute &lt;sql query&gt;
$ mysql -h&lt;host&gt; -P&lt;port&gt; -u&lt;username&gt; -p&lt;password&gt; &lt;database&gt; &lt; test.sql
</code></pre>
<p>启用&rsquo;load data local&rsquo;命令：</p>
<pre><code># 交互式
$ mysql --local-infile=1 -uroot -ppassword
# 非交互式
$ mysql --local-infile=1 -uroot -pchengca w3c -e &quot;LOAD DATA LOCAL INFILE '/home/user/customers.txt' INTO TABLE Customers COLUMNS TERMINATED BY '\t' LINES TERMINATED BY '\n';&quot;
</code></pre>
<p>导出数据命令:</p>
<pre><code>$ mysqldump -u&lt;username&gt; -p&lt;password&gt; &lt;databasename&gt;  &gt;  dump.sql
</code></pre>
<p>mycli:</p>
<p>A command line client for MySQL that can do auto-completion and syntax highlighting.</p>
<p><a href="https://github.com/dbcli/mycli">https://github.com/dbcli/mycli</a></p>
<pre><code>$ pip install -U mycli
</code></pre>
<hr>
<h1 id="cli">CLI</h1>
<p>先用mysql命令进入mysql的命令行。</p>
<pre><code>?         (\?) Synonym for help.
help      (\h) Display this help.

exit      (\q) Exit mysql. Same as quit.
quit      (\q) Quit mysql.

clear     (\c) Clear the current input statement.
connect   (\r) Reconnect to the server. Optional arguments are db and host.
delimiter (\d) Set statement delimiter.
edit      (\e) Edit command with \$EDITOR.
ego       (\G) Send command to mysql server, display result vertically.
go        (\g) Send command to mysql server.
nopager   (\n) Disable pager, print to stdout.
notee     (\t) Don't write into outfile.
pager     (\P) Set PAGER [to_pager]. Print the query results via PAGER.
print     (\p) Print current command.
prompt    (\R) Change your mysql prompt.
rehash    (\#) Rebuild completion hash.

source    (\.) Execute an SQL script file. Takes a file name as an argument.
mysql&gt; source /path/to/dump.sql # 从sql导入数据

status    (\s) Get status information from the server.
system    (\!) Execute a system shell command.
tee       (\T) Set outfile [to_outfile]. Append everything into given outfile.

use       (\u) Use another database. Takes database name as argument.
mysql&gt; use database # 切换到数据库

charset   (\C) Switch to another charset. Might be needed for processing binlog with multi-byte charsets.
warnings  (\W) Show warnings after every statement.
nowarning (\w) Don't show warnings after every statement.
</code></pre>
<p>其它可以在mysql客户端执行的命令：</p>
<pre><code># 从本地一个文件导入数据，列分隔符为\t,行分隔符为\n
LOAD DATA LOCAL INFILE '/home/user/customers.txt' INTO TABLE Customers COLUMNS TERMINATED BY '\t' LINES TERMINATED BY '\n';
</code></pre>
<hr>
<h1 id="数据类型">数据类型</h1>
<hr>
<h1 id="函数和运算符">函数和运算符</h1>
<p>date and time：</p>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/date-and-time-functions.html">https://dev.mysql.com/doc/refman/8.0/en/date-and-time-functions.html</a></p>
<pre><code>NOW() // '2018-11-18 16:00:28'
UTC_TIMESTAMP() // '2018-11-18 08:01:04'
CURDATE()  // '2018-11-18'
UTC_DATE() // '2018-11-18'
CURTIME()  // '16:02:18'
UTC_TIME() // '08:03:36'

UNIX_TIMESTAMP() // '1542528051'
DATE() // '2021-1-12'
TIME() // '14:28:00'
DATEDIFF() 
date_format(column, '%Y-%m-%d')
</code></pre>
<p>control flow:：</p>
<pre><code>CASE

IF()
IFNULL(column, 0)
NULLIF()
</code></pre>
<p>comparison:</p>
<pre><code>COALESCE(column, 0)

ISNULL()
IS NULL

IN()
NOT IN()
</code></pre>
<hr>
<h1 id="sql">SQL</h1>
<p>注意：hostname 指定能连接的server，%表示任何server．</p>
<p>查看版本：</p>
<pre><code>SELECT VERSION();
</code></pre>
<p>查看所有用户：</p>
<pre><code>SELECT DISTINCT(USER) FROM mysql.user;
SELECT user,host,plugin FROM mysql.user;
</code></pre>
<p>查看当前用户：</p>
<pre><code>SELECT USER();
</code></pre>
<p>创建/删除用户：</p>
<pre><code>CREATE USER 'username'@'%' IDENTIFIED BY 'password';
DROP USER 'username'@'%';
</code></pre>
<p>设置和更改密码：</p>
<pre><code>UPDATE mysql.user SET PASSWORD('password') WHRER USER='username' AND HOST='hostname';
</code></pre>
<p>查看所有数据库：</p>
<pre><code>show databases;
</code></pre>
<p>查看当前数据库：</p>
<pre><code>SELECT DATABASE();
</code></pre>
<p>创建/删除数据库：</p>
<pre><code>CREATE DATABASE databasename;
DROP DATABASE databasename;
</code></pre>
<p>指定数据库对用户授权：</p>
<pre><code>GRANT ALL PRIVILEGES ON databasename.* TO 'username'@'%';
FLUSH PRIVILEGES;
</code></pre>
<p>查看权限：</p>
<pre><code>SHOW GRANTS FOR 'username'@'%';
</code></pre>
<p>使用数据库：</p>
<pre><code>use databasename
</code></pre>
<p>查看所有表：</p>
<pre><code>show tables;
</code></pre>
<p>查看表结构：</p>
<pre><code>desc tablename;
</code></pre>
<p>正则：</p>
<pre><code>// 类似like，特殊字符要用双反斜杠转义.
select * from tablename where colume REGEXP '...'
</code></pre>
<p>查看系统配置:</p>
<pre><code>show variables like 'version';
select @@version;
</code></pre>
<hr>
<h1 id="issue">Issue</h1>
<ol>
<li>mysql8  workbench 连不上的问题 :</li>
</ol>
<p>issue:</p>
<pre><code>authentication plugin 'caching_sha2_password' cannot be loaded: the specified module could not be found。
</code></pre>
<p>fix：</p>
<pre><code>mysql8 开始默认授权插件改成caching_sha2_password.
可以指定为--default-authentication-plugin=mysql_native_password，
alter user 'sandbox'@'%' identified with mysql_native_password by 'password';
</code></pre>
<ol start="2">
<li>max_commection 问题:</li>
</ol>
<p>issue:</p>
<pre><code>当连接池连接数量超过最大连接数就无法再建立连接
</code></pre>
<p>fix:</p>
<pre><code>show processlist;
show variables like 'max_connections';
set global max_connections = 2048;
</code></pre>
<ol start="3">
<li>1153, &ldquo;Got a packet bigger than &lsquo;max_allowed_packet&rsquo; bytes&rdquo;</li>
</ol>
<p>issue:</p>
<pre><code>请求数据超过限制，默认可能是4M
</code></pre>
<p>fix:</p>
<pre><code>// 设置成最大值1G
select @@max_allowed_packet;
SET GLOBAL max_allowed_packet = 1024 * 1024 * 1024;
</code></pre>
<ol start="4">
<li>1205, &lsquo;Lock wait timeout exceeded; try restarting transaction&rsquo;</li>
</ol>
<p>issue:</p>
<pre><code>后提交的事务等待前面处理的事务释放锁，但是在等待的时候超过了mysql的锁等待时
</code></pre>
<p>fix:</p>
<pre><code>// 首先优化表索引.
select @@innodb_lock_wait_timeout
set global innodb_lock_wait_timeout=100;
</code></pre>
<p>5. 1840 (HY000) at line 24: @@GLOBAL.GTID_PURGED can only be set when @@GLOBAL.GTID_EXECUTED is empty.</p>
<p>fix:</p>
<pre><code>&quot;mysql&gt; reset master&quot;.
</code></pre>
<hr>
<h1 id="monitoring">Monitoring</h1>

        </div>
    </article>
</div>

        </main>
    </div>
    
    <footer>
        <div class="container">
            <p>&copy; 2025 Morgoth. Designed by Canux</p>
        </div>
    </footer>
</body>
</html>
