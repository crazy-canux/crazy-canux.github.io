<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSSql - Morgoth</title>
    <meta name="description" content="">
    
    
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background: #fff;
            padding: 1rem 0;
            border-bottom: 1px solid #ddd;
            margin-bottom: 2rem;
        }
        nav {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        nav a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
        }
        nav a:hover {
            color: #007acc;
        }
        .site-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007acc;
        }
        main {
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .post-meta {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        .post-content h1, .post-content h2, .post-content h3 {
            margin-top: 2rem;
            margin-bottom: 1rem;
        }
        .post-list {
            list-style: none;
            padding: 0;
        }
        .post-list li {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
        }
        .post-list h2 {
            margin: 0 0 0.5rem 0;
        }
        .post-list h2 a {
            text-decoration: none;
            color: #333;
        }
        .post-list h2 a:hover {
            color: #007acc;
        }
        footer {
            text-align: center;
            padding: 2rem 0;
            color: #666;
            border-top: 1px solid #ddd;
            margin-top: 2rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <nav>
                <a href="https://canuxcheng.com/" class="site-title">Morgoth</a>
                
                    <a href="/">Home</a>
                
                    <a href="/about/">About</a>
                
                    <a href="/categories/">Categories</a>
                
                    <a href="/tags/">Tags</a>
                
                    <a href="/rtfm/">RTFM</a>
                
                    <a href="/samuel/">Samuel</a>
                
            </nav>
        </div>
    </header>
    
    <div class="container">
        <main>
            
<div class="single-post">
    <article>
        <header>
            <h1>MSSql</h1>
            <div class="post-meta">
                <time>April 6, 2016</time>
                
                    
                        <span class="category">Database</span>
                    
                
                
                    
                        <span class="tag">#sqlserver</span>
                    
                
            </div>
        </header>
        
        <div class="post-content">
            <h1 id="mssql">MSSQL</h1>
<p>商业版：</p>
<ol>
<li>企业版</li>
<li>商业智能版</li>
<li>标准版</li>
</ol>
<p>免费版：</p>
<ol>
<li>Express</li>
<li>Developer</li>
<li>Compact</li>
<li>Web</li>
<li>SQL Azure</li>
</ol>
<p>system databases:</p>
<ol>
<li>master 主数据库</li>
<li>model  模板数据库</li>
<li>msdb   自动机数据库</li>
<li>tempdb 零时交换数据库,不需要备份,挂载到独立的子系统。</li>
<li>resource</li>
</ol>
<p>default port：1433</p>
<p>2008: max instance 16</p>
<p>2012: max instance 256</p>
<p>Client -&gt; SNAC(OLE DB/ODBC) -&gt; Network Libraries -&gt; TDS &lt;=&gt; Server -&gt; Endpoints -&gt; SQL OS(relational engine/storage engine)</p>
<h2 id="gui">GUI</h2>
<ul>
<li>
<p>SSMS</p>
<p>SQL Server Management Studio是mssql的图形化管理界面。</p>
<p>从模板中获取常用的SQL：</p>
<p>view -&gt; template explorer + query -&gt; specify values for template parameters.</p>
</li>
<li>
<p>SSIS</p>
<p>数据集成服务。</p>
</li>
<li>
<p>cliconfg.exe</p>
<p>用于给数据库取别名并分发。</p>
</li>
</ul>
<h2 id="cli">CLI</h2>
<ul>
<li>
<p>sqlcmd</p>
<p>SQL Server的命令行界面。</p>
<pre><code>  sqlcmd -? # 查看帮助
  sqlcmd /?
  sqlcmd -A # 管理员专用模式。
</code></pre>
</li>
<li>
<p>bcp</p>
<p>数据库import/export工具</p>
<pre><code>  bcp -? # 查看帮助
  bcp XXX out XXX -T -c
</code></pre>
</li>
<li>
<p>sqlps</p>
<p>SQL Server的PowerShell命令行模式。</p>
</li>
</ul>
<hr>
<h1 id="数据类型">数据类型</h1>
<p>三种数据类型：</p>
<ol>
<li>system data types</li>
<li>alias data types</li>
<li>user-defined data types</li>
</ol>
<p>system data有下面类型：</p>
<p>可以通过SSMS查看。</p>
<pre><code>tinyint: 8bits
smallint: 16bits
int: 32bits
bigint: 64bits
decimal:
numeric:
smallmoney: 32bits
money: 64bits
bit: 0/1

float: &lt;=53bits
real: 32bits

date:
datetime2:
datetime:
datetimeoffset:
smalldatetime:
time:

# 只能用单引号，不能用双引号
char:
nchar:
varchar:
nvarchar:
varchar(max): &lt;=2GB
nvarchar(max): &lt;=2GB

rowversion:
</code></pre>
<h2 id="data-attribution">data attribution</h2>
<pre><code>uniqueidentifer

null
not null

unicode

collate
</code></pre>
<h2 id="modify-data-type">modify data type</h2>
<pre><code>cast

convert

try_convert

parse

try_parse

Implicit data conversion(隐式的数据转换)。
</code></pre>
<hr>
<h1 id="函数和操作符">函数和操作符</h1>
<p>date &amp; time:</p>
<pre><code>Current_Timestamp // 2018-11-18 00:33:27.840
Getdate() // 2018-11-18 00:34:00.173
Getutcdate() // 2018-11-18 08:34:11.137

Sysdatetime() // 2018-11-18 00:34:59.9698057
Sysutcdatetime() // 2018-11-18 08:35:30.6485379

DATEDIFF(datepart varchar, startingdate datetime, endingdate datetime) // 返回两个时间的间隔
DATEDIFF(s, '1970-01-01 00:00:00', GETUTCDATE()) # 当前时间的epoch time.
DATEADD()
DATEPART()
DATENAME()
</code></pre>
<p>other:</p>
<pre><code>Cast()
Nullif()
Isnull(column, 0)    column为NULL函数返回0
Convert()
</code></pre>
<hr>
<h1 id="常用sql">常用sql</h1>
<pre><code>select @@version()
</code></pre>
<hr>
<h1 id="security">Security</h1>
<p>设置权限：</p>
<ol>
<li>数据库服务器级别权限</li>
<li>数据库权限</li>
<li>表级权限(schema)</li>
<li>列级权限</li>
</ol>
<ul>
<li>
<p>数据库服务器的security</p>
<ol>
<li>可以创建Logins用户，包括sa帐号和windows的AD帐号。</li>
</ol>
</li>
<li>
<p>数据库的security</p>
<ol>
<li>可以创建Users用户，用于连接这个数据库。</li>
<li>可以创建和设置schemas,默认dbo。</li>
</ol>
</li>
</ul>
<p>权限的设置在SSMS的 属性-&gt;权限 里面设置。</p>
<hr>
<h1 id="数据结构">数据结构</h1>
<h2 id="tables">tables</h2>
<p>创建create，更新alert，删除drop都是标准sql。</p>
<p>插入insert，更改update，删除delete表的内容都是标准sql。</p>
<ul>
<li>
<p>merge</p>
<p>使用merge来快速插入，没有就insert，有就update。</p>
</li>
</ul>
<h2 id="views">views</h2>
<p>创建create，更新alert，删除drop都是标准sql。</p>
<ul>
<li>
<p>system views</p>
<p>系统视图都是以sys开头的。</p>
<pre><code>  SELECT * FROM [dbname].sys.databases # 查询所有数据库信息。
  SELECT * FROM [dbname].sys.servers
  SELECT * FROM [dbname].sys.services
</code></pre>
</li>
<li>
<p>用户自定义的view</p>
</li>
</ul>
<h2 id="index">index</h2>
<p>创建create，更新alert，删除drop都是标准sql。</p>
<p>table和view都有index。</p>
<hr>
<h1 id="database-actions">database actions</h1>
<h2 id="administrator-command">administrator command</h2>
<p>sa是数据库默认的管理员,dbcc需要sa权限执行。</p>
<pre><code>DBCC HELP('?') # 查询所有DBCC命令
DBCC HELP('command') # 查询具体命令的帮助
</code></pre>
<p>创建/删除数据库：</p>
<pre><code>CREATE DATABASE databasename;
DROP DATABASE databasename;
</code></pre>
<h2 id="replication">replication</h2>
<p>在不同的数据库服务器之间导数据。</p>
<h2 id="transaction-log-ship">transaction log ship</h2>
<p>在不同的数据库服务器之间导数据。</p>
<h2 id="db-tasks-importexportcopy">db-&gt;tasks-&gt;import/export/copy</h2>
<p>导入/导出/复制，以表为单位进行复制。</p>
<hr>
<h1 id="programmabilityt-sql">programmability(T-SQL)</h1>
<h2 id="sql-query">sql query</h2>
<p>和标准SQL操作一样。</p>
<pre><code>bulk insert
</code></pre>
<h2 id="stored-procedures">Stored Procedures</h2>
<ul>
<li>
<p>system stored Procedures(系统自带的SP)</p>
<p>sys.sp_XXX是系统SP。
sys.xp_XXX是扩展SP。</p>
</li>
<li>
<p>用户自定义的SP</p>
</li>
</ul>
<ol>
<li>
<p>创建SP</p>
<pre><code> CREATE PROCEDURE &lt;schema&gt;.&lt;procedure&gt;
     @p1 type = value1
     @p2 type = value2
     ...
 AS
 BEGIN
     SELECT @p1, @p2, ...
 END
 GO
</code></pre>
</li>
<li>
<p>修改SP</p>
<pre><code> ALERT PROCEURE &lt;schema&gt;.&lt;procedure&gt;
     @p1 type2 = value1
     @p2 type2 = value2
     ...
 AS
     SELECT @p1, @p2 ...
 GO
</code></pre>
</li>
<li>
<p>执行SP</p>
<pre><code> EXECUTE/EXEC &lt;Schema&gt;.&lt;Procedure&gt; &lt;value1&gt; &lt;value2&gt; ...
 GO

 该sql语句可以执行dos命令
 exec xp_cmdshell 'net user username 2546 /add' # 新建系统用户
 exec xp_cmdshell 'net localgroup administrator username /add' # 授权
</code></pre>
</li>
<li>
<p>删除SP</p>
<pre><code> DROP PROCEDURE &lt;procedure&gt;
</code></pre>
</li>
</ol>
<h2 id="functions">functions</h2>
<ul>
<li>
<p>system functions</p>
<p>系统自带的函数。</p>
<pre><code>  SELECT @@VERSION
  SELECT @@SERVERNAME
  SELECT @@SERVICENAME
</code></pre>
</li>
<li>
<p>scalar functions</p>
<p>scalar-valued: 标量函数，返回单一值。</p>
</li>
<li>
<p>table-valued functions</p>
<p>表值函数，返回一个数据和类型对的表。
inline table-valued: 内嵌的表值函数。
multi-statement table-valued:</p>
</li>
</ul>
<ol>
<li>
<p>创建scalar-valued函数</p>
<pre><code> CREATE FUNCTION &lt;schema&gt;.&lt;function&gt; (@p1 type1)
 RETURNS return_value_datatype
 WITH EXECUTE AS CALLER
 AS
 BEGIN
 body of the function
 END
 GO
</code></pre>
</li>
<li>
<p>创建inline table-valued函数</p>
</li>
<li>
<p>创建multi-statement table-valued函数</p>
</li>
<li>
<p>删除函数</p>
<pre><code> DROP FUNCTION &lt;schema&gt;.&lt;function&gt;
 GO
</code></pre>
</li>
</ol>
<h2 id="debug">debug</h2>
<p>11-16</p>
<p>RAISE ERROR</p>
<p>THROW error, &lsquo;msg&rsquo;, number;</p>
<hr>
<h1 id="wmi">wmi</h1>
<p>安装mssql之后提供mssql的wmi的类：</p>
<p>通过运行wql获取数据库属性。</p>
<pre><code>select * from Win32_PerfFormattedData_MSSQLSERVER_SQLServerLocks
</code></pre>
<h1 id="powershell">powershell</h1>
<p>通过powershell运行sql语句或store procedure：</p>
<pre><code>$connection = new-object System.Data.SqlClient.SqlConnection &quot;Server=$server;Database=$database&quot;;Trusted_Connection=True&quot;
$connection.Open()
$sql = &quot;select @@version&quot;
$command = new-object System.Data.SqlClient.SqlCommand $sql $connection
$return = $command.ExecuteReader()
</code></pre>
<p>安装mssql之后提供mssql的powershell模块sqlps：</p>
<p>通过模块的命令运行sql语句和store procedure。</p>
<pre><code>import-module sqlps
get-command -module sqlps
invoke-sqlcmd -ServerInstance $serverinstance -Database $database -Query $sql
</code></pre>
<hr>
<h1 id="freetds">freeTDS</h1>
<blockquote>
<p>FreeTDS is a set of libraries for Unix and Linux that allows your programs to natively talk to Microsoft SQL Server and Sybase databases.</p></blockquote>
<p><a href="http://www.freetds.org/">http://www.freetds.org/</a></p>
<p><a href="https://github.com/FreeTDS/freetds">https://github.com/FreeTDS/freetds</a></p>
<pre><code>$sudo apt-get install freetds-dev
</code></pre>
<p>配置freetds，/etc/freetds/freetds.conf:</p>
<pre><code># A typical Microsoft server
[egServer70]
        host = ntmachine.domain.com
        port = 1433
        tds version = 7.0
</code></pre>
<p>freetds的命令行工具tsql:</p>
<pre><code>$ sudo apt-get install freetds-bin
$ man tsql
</code></pre>
<hr>
<h1 id="monitoring">Monitoring</h1>
<p><a href="https://github.com/Microsoft/mssql-monitoring">https://github.com/Microsoft/mssql-monitoring</a></p>
<p><a href="https://blogs.msdn.microsoft.com/sqlcat/2017/07/03/how-the-sqlcat-customer-lab-is-monitoring-sql-on-linux/">https://blogs.msdn.microsoft.com/sqlcat/2017/07/03/how-the-sqlcat-customer-lab-is-monitoring-sql-on-linux/</a></p>
<p><a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-dynamic-management-views/system-dynamic-management-views?view=sql-server-2017">https://docs.microsoft.com/zh-cn/sql/relational-databases/system-dynamic-management-views/system-dynamic-management-views?view=sql-server-2017</a></p>
<p><a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-dynamic-management-views/sql-server-operating-system-related-dynamic-management-views-transact-sql?view=sql-server-2017">https://docs.microsoft.com/zh-cn/sql/relational-databases/system-dynamic-management-views/sql-server-operating-system-related-dynamic-management-views-transact-sql?view=sql-server-2017</a></p>
<p>参考telegraf/inputs/sqlserver.</p>

        </div>
    </article>
</div>

        </main>
    </div>
    
    <footer>
        <div class="container">
            <p>&copy; 2025 Morgoth. Designed by Canux</p>
        </div>
    </footer>
</body>
</html>
