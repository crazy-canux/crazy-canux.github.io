<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kubeadm - Morgoth</title>
    <meta name="description" content="">
    
    
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background: #fff;
            padding: 1rem 0;
            border-bottom: 1px solid #ddd;
            margin-bottom: 2rem;
        }
        nav {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        nav a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
        }
        nav a:hover {
            color: #007acc;
        }
        .site-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007acc;
        }
        main {
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .post-meta {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        .post-content h1, .post-content h2, .post-content h3 {
            margin-top: 2rem;
            margin-bottom: 1rem;
        }
        .post-list {
            list-style: none;
            padding: 0;
        }
        .post-list li {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
        }
        .post-list h2 {
            margin: 0 0 0.5rem 0;
        }
        .post-list h2 a {
            text-decoration: none;
            color: #333;
        }
        .post-list h2 a:hover {
            color: #007acc;
        }
        footer {
            text-align: center;
            padding: 2rem 0;
            color: #666;
            border-top: 1px solid #ddd;
            margin-top: 2rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <nav>
                <a href="https://canuxcheng.com/" class="site-title">Morgoth</a>
                
                    <a href="/">Home</a>
                
                    <a href="/about/">About</a>
                
                    <a href="/categories/">Categories</a>
                
                    <a href="/tags/">Tags</a>
                
                    <a href="/rtfm/">RTFM</a>
                
                    <a href="/samuel/">Samuel</a>
                
            </nav>
        </div>
    </header>
    
    <div class="container">
        <main>
            
<div class="single-post">
    <article>
        <header>
            <h1>Kubeadm</h1>
            <div class="post-meta">
                <time>December 30, 2019</time>
                
                    
                        <span class="category">CNCF</span>
                    
                
                
                    
                        <span class="tag">#k8s</span>
                    
                
            </div>
        </header>
        
        <div class="post-content">
            <h1 id="kubeadm">kubeadm</h1>
<p><a href="https://github.com/kubernetes/kubeadm">https://github.com/kubernetes/kubeadm</a></p>
<p>kubeadm是k8s自带的部署集群的工具.</p>
<h1 id="install">Install</h1>
<h2 id="准备工作">准备工作</h2>
<p><a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/</a></p>
<h2 id="安装runtime">安装runtime</h2>
<p><a href="https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/">https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/</a></p>
<p>默认的cgroup驱动时cgroupfs,如果系统是systemd，就会有两个cgroup driver，会出问题.</p>
<p>如果修改cgroup driver需要同时修改CRI和kubelet.</p>
<p>修改containerd的cgroup driver:</p>
<pre><code>$ sudo vim /etc/containerd/config.toml
#disabled_plugins = [&quot;cri&quot;]
[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]
  SystemdCgroup = true

$ sudo systemctl restart containerd
</code></pre>
<p>修改kubelet的cgroup driver(kubeadm-config.yaml):</p>
<pre><code># kubeadm-config.yaml
kind: ClusterConfiguration
apiVersion: kubeadm.k8s.io/v1beta3
kubernetesVersion: v1.21.0    // kubelet --version
---
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
cgroupDriver: systemd
</code></pre>
<h2 id="安装kubeadm-kubelet-kubectl">安装kubeadm, kubelet, kubectl</h2>
<p>在每台机器上安装 kubeadm, kubelet, kubectl:</p>
<pre><code>$ sudo apt-get update
$ sudo apt-get install -y apt-transport-https ca-certificates curl
$ sudo curl -fsSL https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add - 
$ echo &quot;deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main&quot; | sudo tee /etc/apt/sources.list.d/kubernetes.list
$ sudo apt-get update
$ sudo apt-get --yes --allow-unauthenticated install kubeadm kubelet kubectl
$ sudo apt-mark hold kubelet kubeadm kubectl
$ sudo systemctl enable kubelet
</code></pre>
<hr>
<h1 id="kubeadm-cli">Kubeadm CLI</h1>
<p>init:</p>
<pre><code>$ kubeadm init 
--config kubeadm-config.yaml
--kubernetes-version &lt;version&gt; // kubelet --version
--apiserver-advertise-address &lt;master&gt; // 多网卡指定网卡IP
--image-repository &lt;registry&gt; // default: k8s.gcr.io
--pod-network-cidr &lt;cidr&gt; // 指定pod的cidr
--service-cidr &lt;cidr&gt; // default: 10.96.0.0/12
--service-dns-domain // default: cluster.local
--cri-socket // 如果安装了多个cri需要指定.
--ignore-preflight-errors
--upload-certs
</code></pre>
<p>join:</p>
<pre><code>$ kubeadm join [apiserver-advertise-address] --token &lt;token&gt; --discovery-token-ca-cert-hash &lt;hash&gt;
</code></pre>
<p>reset:</p>
<pre><code>$ kubeadm reset -f/--force
</code></pre>
<p>token:</p>
<pre><code>$ kubeadm token create/delete/generate/list
</code></pre>
<hr>
<h1 id="部署cluster">部署Cluster</h1>
<h2 id="部署master">部署master</h2>
<p>关闭swap</p>
<pre><code>$ sudo swapoff -a
</code></pre>
<p>初始化</p>
<pre><code>$ sudo kubeadm init \
--pod-network-cidr=10.244.0.0/16 \
--apiserver-advertise-address=&lt;IP&gt; \
--kubernetes-version=v1.17.0 \
--image-repository=registry.aliyuncs.com/google_containers \
--cri-socket=/run/containerd/containerd.sock \
-v=6
// --config 一般使用默认即可.
// --pod-network-cidr=10.244.0.0/16 是固定用法，表示选择flannel为网络插件。
// --image-repository 指定registry, 默认是gcr
</code></pre>
<p>配置当前帐号</p>
<pre><code>mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
</code></pre>
<p>部署网络插件</p>
<pre><code>// 在所有node上部署cni-plugin:
// &lt;https://github.com/containernetworking/plugins/releases&gt;
$ sudo mkdir -p /opt/cni/bin
// 下载并解压所有插件命令到该目录. 默认CNI_PATH=/opt/cni/bin

// &lt;https://docs.cilium.io/en/stable/installation/k8s-install-kubeadm/&gt;
// cilium会自动下载plugins到/opt/cni/bin.

// &lt;https://github.com/flannel-io/flannel&gt;
$ kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</code></pre>
<p>配置master是否部署pod</p>
<pre><code># enable master deploy pod (默认不部署pod到master)
kubectl taint nodes --all node-role.kubernetes.io/control-plane-

# disable master deploy pod
kubectl taint nodes &lt;node&gt; node-role.kubernetes.io/master=true:NoSchedule
</code></pre>
<h2 id="部署node">部署node</h2>
<pre><code>$ sudo swapoff -a

// 如果有vpn，kubeadm会自动下载安装
// 在所有node上部署cni-plugin:
// &lt;https://github.com/containernetworking/plugins/releases&gt;
$ sudo mkdir -p /opt/cni/bin
// 下载并解压所有插件命令到该目录.

$ sudo kubeadm join 192.168.1.1:6443 \
--token 8po0v5.m1qlbc7w0btq15of \
--discovery-token-ca-cert-hash sha256:21d8365e336d5218637ddf26e2ec5d91c7dd2de518dbe47973e089837b13265b
</code></pre>
<h2 id="验证">验证</h2>
<pre><code>$ kubectl get pods -n kube-system
$ kubectl get nodes
</code></pre>
<h2 id="删除cluster">删除cluster</h2>
<p>所有node运行:</p>
<pre><code>$ sudo kubeadm reset -f
// 自动停止kubelet并且删除下列文件和目录
[/etc/kubernetes/manifests /etc/kubernetes/pki]
[/etc/kubernetes/admin.conf /etc/kubernetes/kubelet.conf /etc/kubernetes/bootstrap-kubelet.conf /etc/kubernetes/controller-manager.conf /etc/kubernetes/scheduler.conf]
[/var/lib/etcd /var/lib/kubelet /var/lib/dockershim /var/run/kubernetes /var/lib/cni]
</code></pre>
<p>需要手动删除:</p>
<pre><code>$ sudo rm -rf /etc/cni/net.d
</code></pre>
<p>所有node上删除flannel的网络配置</p>
<pre><code>$ sudo ifconfig cni0 down
$ sudo ip link delete cni0
$ sudo ifconfig flannel.1 down
$ sudo ip link delete flannel.1
$ sudo rm -rf /run/flannel
</code></pre>
<p>所有node清空iptables</p>
<pre><code>$ sudo iptables -F
$ sudo iptables -X
$ sudo iptables -t nat -F
$ sudo iptables -t nat -X
</code></pre>
<p>如果使用了IPVS:</p>
<pre><code>$ ipvsadm --clear
</code></pre>
<p>删除配置</p>
<pre><code>$ rm -rf $HOME/.kube
</code></pre>
<h1 id="部署ha-cluster">部署HA Cluster</h1>
<p>ha需要在所有master节点安装haproxy和keepalived.</p>
<p><a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/high-availability/">https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/high-availability/</a></p>
<p><a href="https://github.com/kubernetes/kubeadm/blob/master/docs/ha-considerations.md#options-for-software-load-balancing">https://github.com/kubernetes/kubeadm/blob/master/docs/ha-considerations.md#options-for-software-load-balancing</a></p>
<p>在master1上初始化：</p>
<pre><code>$ sudo kubeadm init --config ./kubeadm.yaml -v=6 --upload-certs
</code></pre>
<p>加入其它master:</p>
<pre><code>$ sudo kubeadm join 192.168.1.200:8443 --token &lt;token&gt; --discovery-token-ca-cert-hash &lt;hash&gt; --control-plane --certificate-key &lt;key&gt;
</code></pre>
<p>加入node:</p>
<pre><code>$ sudo kubeadm join 192.168.1.200:8443 --token &lt;token&gt; --discovery-token-ca-cert-hash &lt;hash&gt;
</code></pre>
<hr>
<h1 id="配置">配置</h1>
<p><a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/control-plane-flags/">https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/control-plane-flags/</a></p>
<p>使用自定义配置:</p>
<pre><code>$ sudo kubeadm init --config ./config.yaml -v=6
</code></pre>
<p>查看默认配置:</p>
<pre><code>$ kubeadm config print init-defaults
</code></pre>
<p>配置kubeadm：</p>
<pre><code>apiVersion: kubeadm.k8s.io/v1beta2
kind: InitConfiguration
bootstrapTokens:
- groups:
  - system:bootstrappers:kubeadm:default-node-token
  token: abcdef.0123456789abcdef
  ttl: 24h0m0s
  usages:
  - signing
  - authentication
localAPIEndpoint:
  advertiseAddress: 10.103.1.1 // master IP
  bindPort: 6443
nodeRegistration:
  criSocket: /run/containerd/containerd.sock
  name: debug // master hostname
  taints:
  - effect: NoSchedule
    key: node-role.kubernetes.io/master
</code></pre>
<p>配置kubernetes:</p>
<pre><code>// 定制control plane
&lt;https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/control-plane-flags/&gt;
apiVersion: kubeadm.k8s.io/v1beta2
kind: ClusterConfiguration
certificatesDir: /etc/kubernetes/pki
clusterName: kubernetes
controlPlaneEndpoint: 10.58.203.200:8443 // HA中haproxy的VIP和port
dns:
  type: CoreDNS
etcd:
  local:
    dataDir: /var/lib/etcd
networking:
  dnsDomain: cluster.local
  serviceSubnet: 10.96.0.0/12
  podSubnet: 10.244.0.0/16 // for flannel
imageRepository: k8s.gcr.io
kubernetesVersion: v1.18.6
controllerManager:
  ...
  extraArgs:
    &lt;https://kubernetes.io/docs/reference/command-line-tools-reference/kube-controller-manager/&gt;
    allocate-node-cidrs: 'true'
    node-cidr-mask-size: '16' // flannel的SubNetLen
    cluster-cidr: '10.0.0.0/8' // flannel的Network
apiServer:
  timeoutForControlPlane: 4m0s
  &lt;https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/&gt;
    extraArgs:
      advertise-address: 192.168.0.103
      ...
scheduler:
  ...
  &lt;https://kubernetes.io/docs/reference/command-line-tools-reference/kube-scheduler/&gt;
  extraArgs:
    ...
</code></pre>
<p>修改kubelet的cgroup driver:</p>
<pre><code>apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
cgroupDriver: systemd
</code></pre>

        </div>
    </article>
</div>

        </main>
    </div>
    
    <footer>
        <div class="container">
            <p>&copy; 2025 Morgoth. Designed by Canux</p>
        </div>
    </footer>
</body>
</html>
