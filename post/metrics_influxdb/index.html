<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Influxdb - Morgoth</title>
    <meta name="description" content="">
    
    
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background: #fff;
            padding: 1rem 0;
            border-bottom: 1px solid #ddd;
            margin-bottom: 2rem;
        }
        nav {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        nav a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
        }
        nav a:hover {
            color: #007acc;
        }
        .site-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007acc;
        }
        main {
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .post-meta {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        .post-content h1, .post-content h2, .post-content h3 {
            margin-top: 2rem;
            margin-bottom: 1rem;
        }
        .post-list {
            list-style: none;
            padding: 0;
        }
        .post-list li {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
        }
        .post-list h2 {
            margin: 0 0 0.5rem 0;
        }
        .post-list h2 a {
            text-decoration: none;
            color: #333;
        }
        .post-list h2 a:hover {
            color: #007acc;
        }
        footer {
            text-align: center;
            padding: 2rem 0;
            color: #666;
            border-top: 1px solid #ddd;
            margin-top: 2rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <nav>
                <a href="https://canuxcheng.com/" class="site-title">Morgoth</a>
                
                    <a href="/">Home</a>
                
                    <a href="/about/">About</a>
                
                    <a href="/categories/">Categories</a>
                
                    <a href="/tags/">Tags</a>
                
                    <a href="/rtfm/">RTFM</a>
                
                    <a href="/samuel/">Samuel</a>
                
            </nav>
        </div>
    </header>
    
    <div class="container">
        <main>
            
<div class="single-post">
    <article>
        <header>
            <h1>Influxdb</h1>
            <div class="post-meta">
                <time>January 18, 2018</time>
                
                    
                        <span class="category">DevOps</span>
                    
                
                
                    
                        <span class="tag">#monitoring</span>
                    
                
            </div>
        </header>
        
        <div class="post-content">
            <h1 id="influxdb">Influxdb</h1>
<p><a href="https://github.com/influxdata/influxdb">https://github.com/influxdata/influxdb</a></p>
<p>Scalable datastore for metrics, events, and real-time analytics.</p>
<p>支持从opentsdb, graphite, collectd等获取数据</p>
<p>默认数据库_internal 用于存储内部运行数据</p>
<p>安装配置参考官方文档</p>
<p>log</p>
<pre><code>$ sudo journalctl -u influxdb.service
</code></pre>
<p>config:</p>
<pre><code># 开通kapacitor的subscription功能
[[subscriber]]
enable = true
</code></pre>
<hr>
<h1 id="数据结构">数据结构</h1>
<p>influxdb每条记录是一个point.</p>
<p>points包括下面部分：</p>
<pre><code>measurement: a measurement, like cpu_load, 相当于表名
tags: zero or more tag, key=value, eg: host=ip
fields: zero or more field, key=value, eg: value=0.18
time: a timestamp

&lt;measurement&gt;[,&lt;tag-key&gt;=&lt;tag-value&gt;...] &lt;field-key&gt;=&lt;field-value&gt;[,&lt;field2-key&gt;=&lt;field2-value&gt;...] [unix-nano-timestamp]
</code></pre>
<p>series: 在一个database中,相同的retention policy, measurement, tag set的数据集，叫一个序列．</p>
<p>RP: retention policy, autogen是默认的存储策略, 用于设置数据保留时间.</p>
<p>CQ: continuous query, 连续查询，自动定时启动一组语句，将结果放在指定数据表中．</p>
<p>IFQL: influx query language.</p>
<hr>
<h1 id="cli">CLI</h1>
<pre><code>$ influx --help
$ influx -username &lt;username&gt; -p &lt;password&gt; -h &lt;hostname&gt;
$ influx -precision rfc3339 # 显示可读的时间戳

$ influx -database 'test' -host '127.0.0.1'
-execute 'select * from &quot;test&quot;.&quot;test&quot;.&quot;test&quot; where time &gt; now() - 30d'
-format 'csv' &gt; test.csv
</code></pre>
<p>database</p>
<pre><code>$ CREATE DATABASE test
$ DROP DATABASE test
$ SHOW DATABASES
$ USE test
</code></pre>
<p>measurement(table)</p>
<pre><code>$ DROP MEASUREMENT &lt;measurement&gt;
$ SHOW MEASUREMENTS
$ SHOW MEASUREMENTS WHERE &lt;tagkey&gt;=&lt;tagvalue&gt;
</code></pre>
<p>tags</p>
<pre><code>$ SHOW TAG KEYS
$ SHOW TAG KEYS FROM &lt;measurement&gt;
$ SHOW TAG VALUES FROM &lt;measurement&gt; WITH KEY=&lt;tagkey&gt;
</code></pre>
<p>fileds</p>
<pre><code>$ SHOW FIELD KEYS
$ SHOW FIELD KEYS FROM &lt;measurement&gt;
</code></pre>
<p>subscription</p>
<pre><code>$ SHOW SUBSCRIPTIONS
$ CREATE SUBSCIPTION &lt;subs_name&gt; ON &lt;db&gt;.&lt;rp&gt; DESTINATIONS (&quot;ANY&quot;|&quot;ALL&quot;) host{&quot;,&quot;, host}
$ DROP SUBSCRIPTION &lt;subs_name&gt; ON &lt;db&gt;.&lt;rp&gt;
</code></pre>
<p>series</p>
<pre><code>$ SHOW SERIES
$ DROP SERIES FROM &lt;measurement&gt; WHERE &lt;tagkey&gt;='&lt;tagvalue&gt;'
$ DROP SERIES WHERE &lt;tagkey&gt;='&lt;tagvalue&gt;' # 从所有measurement删除指定节点的所有数据
</code></pre>
<p>shared</p>
<pre><code>$ drop shard &lt;shard_id&gt;
</code></pre>
<hr>
<h1 id="http-api">HTTP API</h1>
<pre><code>port = 8086
</code></pre>
<h2 id="write">write</h2>
<p>create:</p>
<pre><code>curl -i -XPOST http://localhost:8086/query --data-urlencode &quot;q=CREATE DATABASE mydb&quot;
post /query
data = {
    &quot;q&quot;: &quot;create database &lt;database&gt;&quot;
}
</code></pre>
<h2 id="query">query</h2>
<p>show:</p>
<pre><code>curl -G 'http://localhost:8086/query' --data-urlencode &quot;q=show databases&quot;
get /query
params = {
    &quot;pretty&quot; : True,
    &quot;q&quot;: &quot;show databases&quot;
}
</code></pre>
<hr>
<h1 id="influxql">influxQL</h1>
<p>influxql语句按下列关键字顺序排列</p>
<p>tag_key, field_key, measurement都需要用双引号.</p>
<p>The SELECT clause specifies an InfluxQL function.</p>
<pre><code>select &quot;&lt;field_key/tag_key&gt;&quot; from &quot;&lt;measurement&gt;&quot;
select &quot;&lt;field_key/tag_key&gt;&quot; as &quot;alias&quot; from &quot;&lt;measurement&gt;&quot;
</code></pre>
<p>The INTO clause writes query results to a user-specified measurement.</p>
<pre><code>select &lt;&gt; INTO &quot;&lt;measurement&gt;&quot; from &lt;&gt;
</code></pre>
<p>The FROM clause specifies a single measurement.</p>
<pre><code>select &lt;&gt; from &quot;&lt;measurement&gt;&quot;
</code></pre>
<p>The WHERE clause specifies the time range for the query.</p>
<pre><code>select &lt;&gt; from &lt;&gt; where &lt;condition1&gt; OR/AND &lt;condition2&gt;

# string类型的 value必须用单引号．
select &lt;&gt; from &lt;&gt; where &quot;&lt;tag_key/field_key&gt;&quot; &lt;operation&gt; '&lt;tag_value/field_value&gt;'

now() : time &gt; now(() - 10m

= != &lt; &gt;

RE:
=~ !~
=~  : /.*ERROR.*|.*CRITICAL.*/  /ERROR|CRITICAL/
</code></pre>
<p>The GROUP BY clause groups results by all tags (*) and into 12-minute intervals.</p>
<pre><code>select &lt;&gt; from &lt;&gt; where &lt;&gt; group by &quot;&lt;tag_key&gt;&quot;

fill()
time()/time(1ns/u/ms/s/m/h/d/w)
</code></pre>
<p>The ORDER BY time DESC clause returns results in descending timestamp order.</p>
<pre><code>select &lt;&gt; from &lt;&gt; where &lt;&gt; group by &lt;&gt; order by &lt;time/field_key&gt;
select &lt;&gt; from &lt;&gt; where &lt;&gt; group by &lt;&gt; order by &lt;time/field_key&gt; desc
</code></pre>
<p>The LIMIT 2 clause limits the number of points returned to two.</p>
<pre><code>select &lt;&gt; from &lt;&gt; where &lt;&gt; group by &lt;&gt; order by &lt;&gt; limit &lt;number&gt;
select &lt;&gt; from &lt;&gt; where &lt;&gt; group by &lt;&gt; order by &lt;&gt; desc limit &lt;number&gt;
</code></pre>
<p>The OFFSET 2 clause excludes the first two averages from the query results.</p>
<pre><code>select &lt;&gt; from &lt;&gt; where &lt;&gt; group by &lt;&gt; order by &lt;&gt; limit &lt;number&gt; offset &lt;&gt;
select &lt;&gt; from &lt;&gt; where &lt;&gt; group by &lt;&gt; order by &lt;&gt; desc limit &lt;number&gt; offset &lt;&gt;
</code></pre>
<p>The SLIMIT 1 clause limits the number of series returned to one.</p>
<pre><code>select &lt;&gt; from &lt;&gt; where &lt;&gt; group by &lt;&gt; order by &lt;&gt; limit &lt;&gt; offset &lt;&gt; slimit &lt;&gt;
select &lt;&gt; from &lt;&gt; where &lt;&gt; group by &lt;&gt; order by &lt;&gt; desc limit &lt;&gt; offset &lt;&gt; slimit &lt;&gt;
</code></pre>
<p>The SOFFSET 1 clause paginates the series returned.</p>
<pre><code>select &lt;&gt; from &lt;&gt; where &lt;&gt; group by &lt;&gt; order by &lt;&gt; limit &lt;&gt; offset &lt;&gt; slimit &lt;&gt; soffzet &lt;&gt;
select &lt;&gt; from &lt;&gt; where &lt;&gt; group by &lt;&gt; order by &lt;&gt; desc limit &lt;&gt; offset &lt;&gt; slimit &lt;&gt; soffset&lt;&gt;
</code></pre>
<p>The tz() clause returns the UTC offset for the specified timezone.</p>
<pre><code>select &lt;&gt; from &lt;&gt; where &lt;&gt; group by &lt;&gt; order by &lt;&gt; limit &lt;&gt; offset &lt;&gt; slimit &lt;&gt; soffzet &lt;&gt; tz(&lt;time_zone&gt;)
select &lt;&gt; from &lt;&gt; where &lt;&gt; group by &lt;&gt; order by &lt;&gt; desc limit &lt;&gt; offset &lt;&gt; slimit &lt;&gt; soffset&lt;&gt; tz(&lt;time_zone&gt;)
</code></pre>
<hr>
<h1 id="flux">flux</h1>
<p>influxql的升级版，支持多表查询.</p>
<hr>
<h1 id="function">function</h1>
<h2 id="aggregations">aggregations</h2>
<pre><code>count(&lt;fieldkey&gt;) # 统计fieldvalues行数
distinct(&lt;fieldkey&gt;) # 返回fieldvalues不重复的值的列表
integral(&lt;fieldkey&gt;) # 积分
mean(&lt;fieldkey&gt;) # 返回fieldvalues的算数平均值
median(&lt;fieldkey&gt;) # 返回fieldvalues的排序后的中间值
mode(&lt;fieldkey&gt;) # 返回fieldvalues出现频率最高的值
spread(&lt;fieldkey&gt;) # 返回fieldvalues最值之间的差异
stddev(&lt;fiekdkey&gt;) # 返回fieldvalues的标准偏差
sum(&lt;fieldkey&gt;) # 返回fieldvalues的和
</code></pre>
<h2 id="selectors">selectors</h2>
<pre><code>bottom(&lt;fieldkey&gt;, N) # 返回最小的N个fieldvalues
first(&lt;fieldkey&gt;) # 返回timestamp最小的fieldvalue
last(&lt;fieldkey&gt;) # 返回timestamp最大的fieldvalue
max(&lt;fieldkey&gt;) # 返回最大的fieldvalue
min(&lt;fieldkey&gt;) # 返回最小的fieldvalue
percentile(&lt;fieldkey&gt;, N) # 百分数
sample(&lt;fieldkey&gt;, N) # 返回N个fieldvalue的随即样本
top(&lt;fieldkey&gt;, N) # 返回最大的N个fieldvalue
</code></pre>
<h2 id="transformations">transformations</h2>
<p>transformations函数的field_key可以是aggregations和selectors函数的返回值</p>
<pre><code>cumulative_sum(&lt;field_key&gt;)
derivative(&lt;field_key&gt;, [&lt;unit&gt;]) # 求单位时间的变化率, (cur-last)/(interval/unit)
difference(&lt;field_key&gt;) # 返回连续时间值之间的差异 -&gt; 值的差异
elapsed(&lt;field_key&gt;) # 返回连续时间间隔的差异 -&gt; 时间间隔差异
moving_average()
non_negative_derivative()
non_negative_difference()
</code></pre>
<h2 id="predictors">predictors</h2>
<pre><code>holt_winters(function(&lt;field_key&gt;), N, S)
</code></pre>
<hr>
<h1 id="rp">RP</h1>
<p>数据保存策略.</p>
<p>autogen是默认RP，duration=infinite</p>
<p>duration: 存储的数据时间间隔</p>
<p>replication: 存储的数据副本数量</p>
<pre><code>show retention policies on &quot;&lt;database&gt;&quot;

create retention policy &quot;&lt;rp_name&gt;&quot; on &quot;&lt;database&gt;&quot; duration 30d replication 1 default

drop retention policy &quot;&lt;rp_name&gt;&quot; on &quot;&lt;database&gt;&quot;
</code></pre>
<hr>
<h1 id="cq">CQ</h1>
<p>对超过保存策略指定时间的数据，可以做统计采样.(类似于store procedure).</p>
<p>CQ不能更新，只能删除重建．</p>
<pre><code>show continuous queries

create continuous query &lt;CQ_name&gt; on &lt;database&gt;
begin
    SELECT &lt;function[s]&gt; INTO &lt;destination_measurement&gt; FROM &lt;measurement&gt; [WHERE &lt;stuff&gt;] GROUP BY time(&lt;interval&gt;)[,&lt;tag_key[s]&gt;]
end

DROP CONTINUOUS QUERY &lt;cq_name&gt; ON &lt;database_name&gt;
</code></pre>
<hr>
<h1 id="best-practice">Best Practice</h1>
<pre><code>select 1-(mean(&quot;part&quot;) / mean(&quot;all&quot;)) as &quot;rate&quot;
from (
    select sum(&quot;value&quot;) as &quot;smart&quot; from &quot;jobs_type&quot; where &quot;type&quot;='smart' and $timeFilter
),(
    select sum(&quot;value&quot;) as &quot;all&quot; from &quot;jobs_type&quot; where &quot;type&quot;='reversinglab' and $timeFilter
)
group by time($__interval) fill(none)
</code></pre>

        </div>
    </article>
</div>

        </main>
    </div>
    
    <footer>
        <div class="container">
            <p>&copy; 2025 Morgoth. Designed by Canux</p>
        </div>
    </footer>
</body>
</html>
